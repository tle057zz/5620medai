{% extends "base.html" %}

{% block title %}Processing Clinical Analysis{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-clipboard2-pulse-fill"></i> 
                        Processing Your Clinical Document...
                    </h4>
                </div>
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <h5 class="text-muted">AI Medical Pipeline is analyzing your document</h5>
                        <p class="text-muted">This may take 30-60 seconds depending on document complexity</p>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-bold">Progress</span>
                            <span class="fw-bold" id="progressPercent">2%</span>
                        </div>
                        <div class="progress" style="height: 30px; border-radius: 15px; overflow: hidden;">
                            <div id="progressBar" 
                                 class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" 
                                 style="width: 2%; transition: width 0.3s ease;" 
                                 aria-valuenow="2" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                <span class="ms-2 fw-bold">2%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Current Step Details -->
                    <div class="alert alert-info shadow-sm" role="alert">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                            <div class="flex-grow-1">
                                <strong>Current Step:</strong>
                                <p class="mb-0 mt-2" id="progressText">Initializing analysis...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Pipeline Steps Indicator -->
                    <div class="mt-4">
                        <h6 class="text-muted mb-3">
                            <i class="bi bi-diagram-3"></i> Pipeline Steps (8/8)
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="step-item" data-step="1">
                                    <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                                    <i class="bi bi-circle" style="display: inline;"></i>
                                    <span class="ms-2">1. OCR - Text Extraction</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="step-item" data-step="2">
                                    <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                                    <i class="bi bi-circle" style="display: inline;"></i>
                                    <span class="ms-2">2. Sectionizer</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="step-item" data-step="3">
                                    <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                                    <i class="bi bi-circle" style="display: inline;"></i>
                                    <span class="ms-2">3. NER - Entity Recognition</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="step-item" data-step="4">
                                    <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                                    <i class="bi bi-circle" style="display: inline;"></i>
                                    <span class="ms-2">4. Entity Linking</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="step-item" data-step="5">
                                    <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                                    <i class="bi bi-circle" style="display: inline;"></i>
                                    <span class="ms-2">5. FHIR Mapping</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="step-item" data-step="6">
                                    <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                                    <i class="bi bi-circle" style="display: inline;"></i>
                                    <span class="ms-2">6. Explanation Generator</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="step-item" data-step="7">
                                    <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                                    <i class="bi bi-circle" style="display: inline;"></i>
                                    <span class="ms-2">7. Safety Check</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="step-item" data-step="8">
                                    <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                                    <i class="bi bi-circle" style="display: inline;"></i>
                                    <span class="ms-2">8. Mistral LLM Analysis</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Processing Tips -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <small class="text-muted">
                            <i class="bi bi-lightbulb"></i> 
                            <strong>Tip:</strong> The AI pipeline processes your document through 8 comprehensive steps, 
                            including OCR, entity recognition, FHIR mapping, safety checks, and AI-powered analysis with Mistral LLM.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .step-item {
        padding: 0.5rem;
        border-radius: 0.25rem;
        transition: all 0.3s ease;
    }
    .step-item.active {
        background-color: #e7f3ff;
        font-weight: 600;
    }
    .step-item.completed {
        background-color: #d4edda;
    }
    .step-item i {
        font-size: 1.1rem;
    }
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }
    @keyframes progress-bar-stripes {
        0% { background-position: 1rem 0; }
        100% { background-position: 0 0; }
    }
</style>

<script>
(function() {
    const analysisId = {{ analysis_id|tojson }};
    const bar = document.getElementById('progressBar');
    const percentText = document.getElementById('progressPercent');
    const statusText = document.getElementById('progressText');
    let currentStep = 0;

    // Start processing in background
    fetch(`/clinical-analysis/process-now/${analysisId}`, {method: 'POST'})
        .then(() => {})
        .catch(() => {});

    // Update step indicators based on progress
    function updateStepIndicators(stepNum) {
        // Reset all steps
        document.querySelectorAll('.step-item').forEach((item, idx) => {
            const stepNum = idx + 1;
            item.classList.remove('active', 'completed');
            item.querySelector('.bi-check-circle-fill').style.display = 'none';
            item.querySelector('.bi-circle').style.display = 'inline';
        });

        // Mark completed steps
        for (let i = 1; i < stepNum; i++) {
            const stepItem = document.querySelector(`.step-item[data-step="${i}"]`);
            if (stepItem) {
                stepItem.classList.add('completed');
                stepItem.querySelector('.bi-check-circle-fill').style.display = 'inline';
                stepItem.querySelector('.bi-circle').style.display = 'none';
            }
        }

        // Mark current step as active
        if (stepNum > 0 && stepNum <= 8) {
            const currentItem = document.querySelector(`.step-item[data-step="${stepNum}"]`);
            if (currentItem && !currentItem.classList.contains('completed')) {
                currentItem.classList.add('active');
            }
        }
    }

    // Poll progress
    const poll = setInterval(() => {
        fetch(`/clinical-analysis/progress/${analysisId}`)
            .then(r => r.json())
            .then(d => {
                const p = Math.max(2, Math.min(100, d.pct || 0));
                bar.style.width = p + '%';
                bar.setAttribute('aria-valuenow', p);
                bar.innerHTML = `<span class="ms-2 fw-bold">${p}%</span>`;
                percentText.textContent = p + '%';
                statusText.textContent = d.status || 'Processing...';

                // Update step indicators based on percentage
                if (p < 15) {
                    currentStep = 1;
                } else if (p < 30) {
                    currentStep = 2;
                } else if (p < 48) {
                    currentStep = 3;
                } else if (p < 62) {
                    currentStep = 4;
                } else if (p < 75) {
                    currentStep = 5;
                } else if (p < 85) {
                    currentStep = 6;
                } else if (p < 92) {
                    currentStep = 7;
                } else if (p < 98) {
                    currentStep = 8;
                } else {
                    currentStep = 8;
                }
                updateStepIndicators(currentStep);

                if (d.done) {
                    clearInterval(poll);
                    // Remove animation class when done
                    bar.classList.remove('progress-bar-animated');
                    
                    // Mark all steps as completed
                    updateStepIndicators(9); // All 8 steps done
                    
                    // Hide spinner
                    const spinner = document.querySelector('.spinner-border');
                    if (spinner) {
                        spinner.style.display = 'none';
                    }
                    
                    if (d.success) {
                        bar.classList.remove('bg-primary');
                        bar.classList.add('bg-success');
                        statusText.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> <strong>Analysis complete!</strong> Redirecting to results...';
                        
                        // Auto-redirect to results page after 1.5 seconds
                        setTimeout(() => {
                            const redirectUrl = d.results_url || '/clinical-analysis/results/' + analysisId;
                            window.location.href = redirectUrl;
                        }, 1500);
                    } else {
                        bar.classList.remove('bg-primary');
                        bar.classList.add('bg-danger');
                        statusText.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i> <strong>Analysis failed:</strong> ' + (d.status || 'Unknown error');
                        
                        // Auto-redirect after 3 seconds even on failure
                        setTimeout(() => {
                            const redirectUrl = d.results_url || '/clinical-analysis';
                            window.location.href = redirectUrl;
                        }, 3000);
                    }
                    return;
                }
            })
            .catch(() => {
                // Keep polling gently on error
            });
    }, 500); // Poll every 500ms
})();
</script>
{% endblock %}

