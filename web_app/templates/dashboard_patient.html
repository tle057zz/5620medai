{% extends "base.html" %}

{% block title %}Patient Dashboard - Clinical AI System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-person-heart"></i> Patient Dashboard</h2>
                <p class="text-muted">Welcome back, {{ user.get_display_name() }}</p>
            </div>
            <div>
                <span class="badge bg-info fs-6">MRN: {{ user.medical_record_number }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Patient Info Card -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-person-badge"></i> My Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Name:</strong> {{ user.get_display_name() }}</p>
                        <p><strong>Date of Birth:</strong> {{ user.date_of_birth }}</p>
                        <p><strong>Email:</strong> {{ user.email }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Medical Record Number:</strong> {{ user.medical_record_number }}</p>
                        <p><strong>Account Status:</strong> <span class="badge bg-success">Active</span></p>
                        <p><strong>Last Visit:</strong> 
                            {% if rds and rds.last_visit %}
                                {{ rds.last_visit.strftime('%B %d, %Y') }}
                            {% else %}
                                No visits yet
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body text-center">
                <i class="bi bi-file-earmark-medical display-4 text-primary"></i>
                <h3 class="mt-2">{{ rds.stats.medical_reports if rds and rds.stats else 0 }}</h3>
                <p class="text-muted mb-0">Medical Reports</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <i class="bi bi-capsule display-4 text-success"></i>
                <h3 class="mt-2">{{ rds.stats.active_medications if rds and rds.stats else 0 }}</h3>
                <p class="text-muted mb-0">Active Medications</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body text-center">
                <i class="bi bi-calendar-check display-4 text-warning"></i>
                <h3 class="mt-2">{{ rds.stats.upcoming_appointments if rds and rds.stats else 0 }}</h3>
                <p class="text-muted mb-0">Upcoming Appointments</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <i class="bi bi-shield-check display-4 text-info"></i>
                <h3 class="mt-2">{{ rds.stats.insurance_quotes if rds and rds.stats else 0 }}</h3>
                <p class="text-muted mb-0">Insurance Quotes</p>
            </div>
        </div>
    </div>
</div>

<!-- AI Features Row -->
<div class="row g-4 mb-4">
    <!-- Insurance Quote Service (First) -->
    <div class="col-md-6">
        <div class="card shadow-sm border-info h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-shield-check"></i> Insurance Quote Service</h5>
            </div>
            <div class="card-body">
                <h5>Get Personalized Insurance Quotes</h5>
                <p class="text-muted">
                    Our AI-powered system analyzes your health data, medical history, and income details 
                    to match you with the most suitable insurance products.
                </p>
                <ul class="mb-3 small">
                    <li>AI-driven risk assessment and product matching</li>
                    <li>Personalized quotes ranked by suitability</li>
                    <li>Compare coverage, costs, and benefits</li>
                    <li>Download and share quotes with doctors</li>
                </ul>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('request_insurance_quote') }}" class="btn btn-info">
                        <i class="bi bi-plus-circle"></i> Request Quote
                    </a>
                    <a href="{{ url_for('insurance_quote_history') }}" class="btn btn-outline-info">
                        <i class="bi bi-clock-history"></i> View History
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Clinical Record Analysis (Second) -->
    <div class="col-md-6">
        <div class="card shadow-sm border-primary h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-file-medical-fill"></i> Clinical Record Analysis</h5>
            </div>
            <div class="card-body">
                <h5>AI-Assisted Document Analysis</h5>
                <p class="text-muted">
                    Upload your medical documents for comprehensive AI analysis. Get structured 
                    FHIR data, patient-friendly explanations, and safety alerts.
                </p>
                <ul class="mb-3 small">
                    <li>OCR text extraction from PDFs/images</li>
                    <li>Entity recognition (conditions, medications, labs)</li>
                    <li>FHIR R4 compliant data mapping</li>
                    <li>Safety checks & red flag detection</li>
                </ul>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('clinical_analysis') }}" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Analyze Document
                    </a>
                    <a href="{{ url_for('clinical_analysis_history') }}" class="btn btn-outline-primary">
                        <i class="bi bi-clock-history"></i> View History
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Financial Assistance (NEW - Venkatesh) (Third) -->
    <div class="col-md-6">
        <div class="card shadow-sm border-warning h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Financial Assistance (NEW)</h5>
            </div>
            <div class="card-body">
                <h5>Subsidy Eligibility & Assistance</h5>
                <p class="text-muted">
                    Check your eligibility for government subsidies, payment plans, and financial 
                    assistance programs to help with insurance premiums.
                </p>
                <ul class="mb-3 small">
                    <li>Medicare & Health Care Card benefits (15-30% off)</li>
                    <li>Pensioner & student discounts</li>
                    <li>Family size assistance</li>
                    <li>Payment plans & low-interest loans</li>
                    <li>Charity care programs</li>
                </ul>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('request_financial_assistance') }}" class="btn btn-warning">
                        <i class="bi bi-calculator"></i> Calculate Subsidies
                    </a>
                </div>
                <div class="alert alert-info mt-3 mb-0 small">
                    <i class="bi bi-info-circle-fill"></i> You may qualify for significant premium reductions!
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Health Summary -->
<div class="row">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-capsule"></i> Current Medications</h5>
            </div>
            <div class="card-body">
                {% if rds and rds.medications and rds.medications|length > 0 %}
                    <ul class="list-group list-group-flush">
                        {% for medication in rds.medications %}
                        <li class="list-group-item">
                            <strong>{{ medication.get('name', medication) }}</strong>
                            <br><small class="text-muted">
                                Recorded: 
                                {% if medication.get('recorded_at') %}
                                    {{ medication.get('recorded_at').strftime('%b %d, %Y at %I:%M %p') }}
                                {% else %}
                                    Unknown date
                                {% endif %}
                            </small>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">
                        <i class="bi bi-info-circle"></i> No medications recorded yet.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-heart-pulse"></i> Health Conditions</h5>
            </div>
            <div class="card-body">
                {% if rds and rds.conditions and rds.conditions|length > 0 %}
                    <ul class="list-group list-group-flush">
                        {% for condition in rds.conditions %}
                        <li class="list-group-item">
                            <span class="badge bg-danger">Active</span> {{ condition.get('name', condition) }}
                            <br><small class="text-muted">
                                Recorded: 
                                {% if condition.get('recorded_at') %}
                                    {{ condition.get('recorded_at').strftime('%b %d, %Y at %I:%M %p') }}
                                {% else %}
                                    Unknown date
                                {% endif %}
                            </small>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">
                        <i class="bi bi-info-circle"></i> No health conditions recorded yet.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

