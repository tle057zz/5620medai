{% extends "base.html" %}

{% block title %}Financial Assistance Results{% endblock %}

{% block extra_css %}
<style>
.subsidy-card {
    border-left: 4px solid;
    transition: transform 0.2s;
}
.subsidy-card:hover {
    transform: translateX(5px);
}
.affordability-gauge {
    height: 30px;
    background: linear-gradient(to right, #dc3545 0%, #ffc107 50%, #28a745 100%);
    border-radius: 15px;
    position: relative;
}
.affordability-pointer {
    position: absolute;
    top: -5px;
    width: 4px;
    height: 40px;
    background: #000;
    border-radius: 2px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h1 class="display-6 mb-2">
                                <i class="bi bi-cash-coin text-success"></i> 
                                Your Financial Assistance Results
                            </h1>
                            <p class="text-muted mb-0">
                                Subsidy eligibility calculated for your household
                            </p>
                        </div>
                        <div>
                            {% if from_quote_id %}
                            <a href="{{ url_for('view_insurance_quotes', request_id=from_quote_id) }}" class="btn btn-outline-secondary me-2">
                                <i class="bi bi-arrow-left"></i> Back to Quotes
                            </a>
                            {% endif %}
                            <a href="{{ url_for('export_assistance_recommendation', recommendation_id=recommendation.request_id) }}" 
                               class="btn btn-outline-primary">
                                <i class="bi bi-download"></i> Export JSON
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cost Comparison -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg">
                <div class="card-body p-4">
                    <h4 class="mb-4 text-center">
                        <i class="bi bi-piggy-bank-fill text-success"></i> 
                        Your Savings Breakdown
                    </h4>
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded">
                                <small class="text-muted text-uppercase">Original Premium</small>
                                <h2 class="mt-2 mb-0 text-danger">
                                    ${{ "%.2f"|format(recommendation.original_monthly_cost) }}
                                </h2>
                                <small class="text-muted">/month</small>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-center justify-content-center">
                            <div class="text-center">
                                <i class="bi bi-arrow-right display-4 text-success"></i>
                                <div class="mt-2">
                                    <span class="badge bg-success fs-6">
                                        -${{ "%.2f"|format(recommendation.total_monthly_subsidy) }}/mo
                                    </span>
                                    <br>
                                    <small class="text-muted">
                                        ${{ "%.2f"|format(recommendation.total_annual_subsidy) }}/year saved
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-success text-white rounded">
                                <small class="text-uppercase">New Premium</small>
                                <h2 class="mt-2 mb-0">
                                    ${{ "%.2f"|format(recommendation.monthly_cost_after_subsidy) }}
                                </h2>
                                <small>/month</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Affordability Score -->
    {% if recommendation.affordability_score %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-{% if recommendation.affordability_score.is_affordable %}success{% else %}warning{% endif %} text-{% if recommendation.affordability_score.is_affordable %}white{% else %}dark{% endif %}">
                    <h5 class="mb-0">
                        <i class="bi bi-speedometer2"></i> 
                        Affordability Assessment: {{ recommendation.affordability_score.rating }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6>Affordability Score: {{ recommendation.affordability_score.score }}/100</h6>
                            <div class="affordability-gauge">
                                <div class="affordability-pointer" style="left: {{ recommendation.affordability_score.score }}%;"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-2 small text-muted">
                                <span>Unaffordable</span>
                                <span>Borderline</span>
                                <span>Affordable</span>
                            </div>
                            
                            <div class="mt-3">
                                <strong>Cost as % of Income:</strong> 
                                <span class="badge bg-{% if recommendation.affordability_score.percentage_of_income <= 8 %}success{% elif recommendation.affordability_score.percentage_of_income <= 12 %}info{% elif recommendation.affordability_score.percentage_of_income <= 15 %}warning{% else %}danger{% endif %} fs-6">
                                    {{ "%.1f"|format(recommendation.affordability_score.percentage_of_income) }}%
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="display-1">
                                {% if recommendation.affordability_score.is_affordable %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                                {% else %}
                                <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                                {% endif %}
                            </div>
                            <h5 class="mt-2">
                                {% if recommendation.affordability_score.is_affordable %}
                                Affordable!
                                {% else %}
                                Needs Assistance
                                {% endif %}
                            </h5>
                        </div>
                    </div>

                    {% if recommendation.affordability_score.concerns %}
                    <div class="alert alert-warning mt-3">
                        <h6 class="alert-heading">
                            <i class="bi bi-exclamation-triangle-fill"></i> Concerns:
                        </h6>
                        <ul class="mb-0">
                            {% for concern in recommendation.affordability_score.concerns %}
                            <li>{{ concern }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if recommendation.affordability_score.recommendations %}
                    <div class="alert alert-info mt-3">
                        <h6 class="alert-heading">
                            <i class="bi bi-lightbulb-fill"></i> Recommendations:
                        </h6>
                        <ul class="mb-0">
                            {% for rec in recommendation.affordability_score.recommendations %}
                            <li>{{ rec }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Left Column: Subsidies -->
        <div class="col-lg-8">
            <!-- Applicable Subsidies -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-ticket-perforated-fill"></i> 
                        Your Eligible Subsidies ({{ recommendation.subsidies|length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if recommendation.subsidies %}
                    <div class="subsidy-list">
                        {% for subsidy in recommendation.subsidies %}
                        <div class="card subsidy-card mb-3" style="border-left-color: 
                            {% if subsidy.subsidy_type.value == 'medicare' %}#0d6efd
                            {% elif subsidy.subsidy_type.value == 'medicaid' or 'state_program' in subsidy.subsidy_type.value %}#198754
                            {% else %}#ffc107{% endif %};">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            {% if 'medicare' in subsidy.subsidy_type.value %}
                                            <i class="bi bi-hospital text-primary"></i> Medicare Benefit
                                            {% elif 'health_care' in subsidy.rationale.lower() %}
                                            <i class="bi bi-credit-card text-success"></i> Health Care Card
                                            {% elif 'pensioner' in subsidy.rationale.lower() %}
                                            <i class="bi bi-person-fill text-info"></i> Pensioner Discount
                                            {% elif 'student' in subsidy.rationale.lower() %}
                                            <i class="bi bi-mortarboard text-warning"></i> Student Discount
                                            {% elif 'household' in subsidy.rationale.lower() or 'family' in subsidy.rationale.lower() %}
                                            <i class="bi bi-people-fill text-primary"></i> Family Assistance
                                            {% else %}
                                            <i class="bi bi-award text-success"></i> {{ subsidy.subsidy_type.value|replace('_', ' ')|title }}
                                            {% endif %}
                                        </h6>
                                        <p class="mb-2">{{ subsidy.rationale }}</p>
                                        <span class="badge bg-{% if subsidy.eligibility_status.value == 'eligible' %}success{% else %}warning{% endif %}">
                                            {{ subsidy.eligibility_status.value|replace('_', ' ')|title }}
                                        </span>
                                    </div>
                                    <div class="text-end ms-3">
                                        <h4 class="mb-0 text-success">
                                            ${{ "%.2f"|format(subsidy.monthly_subsidy_amount) }}
                                        </h4>
                                        <small class="text-muted">/month</small>
                                        <div class="mt-1">
                                            <small class="text-muted">
                                                ${{ "%.2f"|format(subsidy.annual_subsidy_amount) }}/year
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if subsidy.requirements %}
                                <div class="mt-3 border-top pt-3">
                                    <strong class="small">Requirements:</strong>
                                    <ul class="small mb-0 mt-1">
                                        {% for req in subsidy.requirements %}
                                        <li>{{ req }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill"></i> 
                        No government subsidies available based on your profile.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Additional Assistance Options -->
            {% if recommendation.assistance_options %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-life-preserver"></i> 
                        Additional Assistance Options ({{ recommendation.assistance_options|length }})
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Based on your financial profile, you may qualify for these additional programs:</p>
                    
                    {% for option in recommendation.assistance_options %}
                    <div class="card mb-3 border-{% if option.option_type == 'payment_plan' %}info{% elif option.option_type == 'loan' %}primary{% elif option.option_type == 'charity' %}success{% else %}secondary{% endif %}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6>
                                        {% if option.option_type == 'payment_plan' %}
                                        <i class="bi bi-calendar-week text-info"></i> Payment Plan
                                        {% elif option.option_type == 'loan' %}
                                        <i class="bi bi-cash-stack text-primary"></i> Medical Loan
                                        {% elif option.option_type == 'charity' %}
                                        <i class="bi bi-heart-fill text-success"></i> Charity Assistance
                                        {% else %}
                                        <i class="bi bi-gear-fill"></i> {{ option.option_type|title }}
                                        {% endif %}
                                    </h6>
                                    <strong>{{ option.provider }}</strong>
                                    <p class="mb-2 mt-2">{{ option.terms }}</p>
                                    
                                    <div class="row small">
                                        <div class="col-md-6">
                                            <strong>Amount:</strong> ${{ "%.2f"|format(option.amount) }}
                                        </div>
                                        {% if option.interest_rate is not none %}
                                        <div class="col-md-6">
                                            <strong>Interest Rate:</strong> {{ "%.1f"|format(option.interest_rate) }}% APR
                                        </div>
                                        {% endif %}
                                        {% if option.repayment_period_months %}
                                        <div class="col-md-6">
                                            <strong>Term:</strong> {{ option.repayment_period_months }} months
                                        </div>
                                        {% endif %}
                                        <div class="col-md-6">
                                            <strong>Approval Likelihood:</strong> 
                                            <span class="badge bg-{% if option.approval_likelihood >= 0.7 %}success{% elif option.approval_likelihood >= 0.4 %}warning{% else %}secondary{% endif %}">
                                                {{ (option.approval_likelihood * 100)|int }}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3 border-top pt-3">
                                <strong class="small">Eligibility Criteria:</strong>
                                <ul class="small mb-2">
                                    {% for criteria in option.eligibility_criteria %}
                                    <li>{{ criteria }}</li>
                                    {% endfor %}
                                </ul>
                                <small class="text-muted">
                                    <i class="bi bi-arrow-right-circle"></i> {{ option.application_process }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Recommendation Summary -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-{% if recommendation.recommended %}success{% else %}danger{% endif %} text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-{% if recommendation.recommended %}check-circle{% else %}x-circle{% endif %}-fill"></i> 
                        Our Recommendation
                    </h5>
                </div>
                <div class="card-body">
                    <p class="lead">{{ recommendation.recommendation_rationale }}</p>
                    
                    {% if recommendation.next_steps %}
                    <h6 class="mt-4 mb-3">
                        <i class="bi bi-list-check"></i> Next Steps:
                    </h6>
                    <ol>
                        {% for step in recommendation.next_steps %}
                        <li class="mb-2">{{ step }}</li>
                        {% endfor %}
                    </ol>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Summary Info -->
        <div class="col-lg-4">
            <!-- Financial Profile Summary -->
            <div class="card border-0 shadow-sm mb-4 sticky-top" style="top: 20px;">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-person-lines-fill"></i> Your Profile
                    </h6>
                </div>
                <div class="card-body">
                    <dl class="row small mb-0">
                        <dt class="col-sm-6">Annual Income:</dt>
                        <dd class="col-sm-6">${{ "{:,.0f}".format(recommendation.financial_profile.annual_income) }}</dd>
                        
                        <dt class="col-sm-6">Household Size:</dt>
                        <dd class="col-sm-6">{{ recommendation.financial_profile.household_size }}</dd>
                        
                        <dt class="col-sm-6">State:</dt>
                        <dd class="col-sm-6">{{ recommendation.financial_profile.state }}</dd>
                        
                        <dt class="col-sm-6">FPL %:</dt>
                        <dd class="col-sm-6">
                            <span class="badge bg-info">
                                {{ "%.0f"|format(recommendation.financial_profile.federal_poverty_level_percentage()) }}%
                            </span>
                        </dd>
                        
                        <dt class="col-sm-12 mt-2">Benefits:</dt>
                        <dd class="col-sm-12">
                            {% if recommendation.financial_profile.has_medicare_card %}
                            <span class="badge bg-primary mb-1">Medicare</span>
                            {% endif %}
                            {% if recommendation.financial_profile.has_health_care_card %}
                            <span class="badge bg-success mb-1">Health Care Card</span>
                            {% endif %}
                            {% if recommendation.financial_profile.pensioner %}
                            <span class="badge bg-info mb-1">Pensioner</span>
                            {% endif %}
                            {% if recommendation.financial_profile.student %}
                            <span class="badge bg-warning text-dark mb-1">Student</span>
                            {% endif %}
                            {% if not (recommendation.financial_profile.has_medicare_card or recommendation.financial_profile.has_health_care_card or recommendation.financial_profile.pensioner or recommendation.financial_profile.student) %}
                            <span class="text-muted">None</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- Actions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h6 class="mb-3">Actions</h6>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('export_assistance_recommendation', recommendation_id=recommendation.request_id) }}" 
                           class="btn btn-outline-primary" download>
                            <i class="bi bi-download"></i> Download Report (JSON)
                        </a>
                        <button onclick="window.print()" class="btn btn-outline-secondary">
                            <i class="bi bi-printer"></i> Print Results
                        </button>
                        <a href="{{ url_for('request_financial_assistance') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-counterclockwise"></i> Recalculate
                        </a>
                        {% if from_quote_id %}
                        <a href="{{ url_for('view_insurance_quotes', request_id=from_quote_id) }}" class="btn btn-primary">
                            <i class="bi bi-arrow-left"></i> Back to Quotes
                        </a>
                        {% else %}
                        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                            <i class="bi bi-house"></i> Back to Dashboard
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Help Card -->
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-question-circle-fill"></i> Need Help?
                    </h6>
                    <ul class="small mb-0">
                        <li>Contact Services Australia: 13 2490</li>
                        <li>Medicare hotline: 132 011</li>
                        <li>Financial counselling: 1800 007 007</li>
                        <li><a href="#" class="text-decoration-none">Request human advisor</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

