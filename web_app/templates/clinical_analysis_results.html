{% extends "base.html" %}

{% block title %}Analysis Results - {{ result.patient_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h1 class="display-6 mb-2">
                                <i class="bi bi-clipboard2-pulse-fill text-primary"></i> 
                                Clinical Analysis Results
                            </h1>
                            <p class="text-muted mb-0">
                                Analysis ID: <code>{{ result.analysis_id }}</code> | 
                                Processed: {{ result.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                            </p>
                        </div>
                        <div>
                            <a href="{{ url_for('clinical_analysis') }}" class="btn btn-outline-primary">
                                <i class="bi bi-plus-circle"></i> New Analysis
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Level Alert -->
    {% if result.risk_level in ['high', 'critical'] %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger shadow-sm" role="alert">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-triangle-fill"></i> 
                    {% if result.risk_level == 'critical' %}CRITICAL{% else %}HIGH{% endif %} Risk Alert
                </h5>
                <p class="mb-2"><strong>{{ result.red_flags|length }} red flag(s) detected:</strong></p>
                <ul class="mb-0">
                    {% for flag in result.red_flags %}
                    <li>{{ flag }}</li>
                    {% endfor %}
                </ul>
                <hr>
                <p class="mb-0 small">
                    <strong>Action Required:</strong> Please consult with a healthcare professional immediately to review these findings.
                </p>
            </div>
        </div>
    </div>
    {% elif result.risk_level == 'medium' %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning shadow-sm" role="alert">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-circle-fill"></i> Medium Risk Alert
                </h5>
                <p class="mb-2"><strong>{{ result.red_flags|length }} warning(s) detected:</strong></p>
                <ul class="mb-0">
                    {% for flag in result.red_flags %}
                    <li>{{ flag }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Patient Summary -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person-fill"></i> Patient Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <h6 class="text-muted">Patient Name</h6>
                            <p class="fs-5">{{ result.patient_name or "Unknown" }}</p>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted">Document Type</h6>
                            <p class="fs-5">{{ result.document_type|replace('_', ' ')|title }}</p>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted">Risk Level</h6>
                            <p class="fs-5">
                                {% if result.risk_level == 'critical' %}
                                <span class="badge bg-danger fs-6">CRITICAL</span>
                                {% elif result.risk_level == 'high' %}
                                <span class="badge bg-danger fs-6">HIGH</span>
                                {% elif result.risk_level == 'medium' %}
                                <span class="badge bg-warning text-dark fs-6">MEDIUM</span>
                                {% elif result.risk_level == 'low' %}
                                <span class="badge bg-success fs-6">LOW</span>
                                {% else %}
                                <span class="badge bg-secondary fs-6">UNKNOWN</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted">Status</h6>
                            <p class="fs-5">
                                <span class="badge bg-success fs-6">
                                    <i class="bi bi-check-circle-fill"></i> COMPLETE
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Extracted Clinical Data -->
    <div class="row mb-4">
        <!-- Conditions -->
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-heart-pulse-fill text-danger"></i> 
                        Conditions ({{ result.conditions|length }})
                    </h6>
                </div>
                <div class="card-body">
                    {% if result.conditions %}
                    <ul class="list-group list-group-flush">
                        {% for condition in result.conditions %}
                        <li class="list-group-item">
                            <i class="bi bi-arrow-right-circle-fill text-primary"></i> {{ condition }}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mb-0">No conditions identified</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Medications -->
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-capsule-pill text-success"></i> 
                        Medications ({{ result.medications|length }})
                    </h6>
                </div>
                <div class="card-body">
                    {% if result.medications %}
                    <ul class="list-group list-group-flush">
                        {% for medication in result.medications %}
                        <li class="list-group-item">
                            <i class="bi bi-arrow-right-circle-fill text-primary"></i> {{ medication }}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mb-0">No medications identified</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Observations -->
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-clipboard-data-fill text-info"></i> 
                        Observations ({{ result.observations|length }})
                    </h6>
                </div>
                <div class="card-body">
                    {% if result.observations %}
                    <ul class="list-group list-group-flush">
                        {% for observation in result.observations %}
                        <li class="list-group-item">
                            <i class="bi bi-arrow-right-circle-fill text-primary"></i> {{ observation }}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mb-0">No observations identified</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Procedures -->
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-activity text-warning"></i> 
                        Procedures ({{ result.procedures|length }})
                    </h6>
                </div>
                <div class="card-body">
                    {% if result.procedures %}
                    <ul class="list-group list-group-flush">
                        {% for procedure in result.procedures %}
                        <li class="list-group-item">
                            <i class="bi bi-arrow-right-circle-fill text-primary"></i> {{ procedure }}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mb-0">No procedures identified</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Patient-Friendly Explanation (Pipeline) -->
    {% if result.explanation_text %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-quote-fill"></i> Patient-Friendly Explanation
                        <span class="badge bg-light text-dark ms-2">Pipeline Analysis</span>
                    </h5>
                </div>
                <div class="card-body">
                    <pre class="mb-0" style="white-space: pre-wrap; font-family: system-ui;">{{ result.explanation_text }}</pre>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Mistral LLM Analysis -->
    {% if result.mistral_analysis %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-robot"></i> AI-Powered Clinical Analysis
                        <span class="badge bg-warning text-dark ms-2">Mistral:7B-Instruct LLM</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> This analysis is generated by <strong>mistral:7b-instruct</strong> LLM, providing additional AI-powered insights beyond the standard pipeline.
                    </div>
                    <pre class="mb-0" style="white-space: pre-wrap; font-family: system-ui; background-color: #f8f9fa; padding: 1rem; border-radius: 0.25rem;">{{ result.mistral_analysis }}</pre>
                </div>
            </div>
        </div>
    </div>
    {% elif result.explanation_text %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-secondary">
                <i class="bi bi-info-circle"></i> <strong>Mistral LLM Analysis:</strong> Not available. The LLM service may be unavailable or processing failed.
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Processing Steps Timeline -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-diagram-3-fill"></i> Processing Pipeline
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for step in result.processing_steps %}
                        <div class="d-flex mb-3">
                            <div class="me-3">
                                {% if step.status == 'completed' %}
                                <i class="bi bi-check-circle-fill text-success fs-5"></i>
                                {% elif step.status == 'failed' %}
                                <i class="bi bi-x-circle-fill text-danger fs-5"></i>
                                {% elif step.status == 'skipped' %}
                                <i class="bi bi-dash-circle-fill text-secondary fs-5"></i>
                                {% else %}
                                <i class="bi bi-arrow-right-circle-fill text-primary fs-5"></i>
                                {% endif %}
                            </div>
                            <div>
                                <h6 class="mb-1">{{ step.step }}</h6>
                                <p class="text-muted mb-0 small">
                                    Status: <span class="badge bg-{{ 'success' if step.status == 'completed' else ('danger' if step.status == 'failed' else 'secondary') }}">{{ step.status|upper }}</span>
                                    {% if step.details %}
                                    | {{ step.details }}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Options -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-download"></i> Download Reports
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <a href="{{ url_for('download_fhir_bundle', analysis_id=result.analysis_id) }}" 
                               class="btn btn-primary w-100">
                                <i class="bi bi-file-earmark-medical"></i> Download FHIR Bundle (JSON)
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('download_clinical_report', analysis_id=result.analysis_id) }}" 
                               class="btn btn-outline-primary w-100">
                                <i class="bi bi-file-earmark-text"></i> Download Complete Report (JSON)
                            </a>
                        </div>
                        <div class="col-md-4">
                            <button onclick="window.print()" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-printer"></i> Print Results
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex gap-2">
                <a href="{{ url_for('clinical_analysis') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Analyze Another Document
                </a>
                <a href="{{ url_for('clinical_analysis_history') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-clock-history"></i> View History
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-house-door"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

